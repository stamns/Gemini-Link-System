<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿å¯¹è¯ - Gemini Link System</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/style.css">
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            background: var(--bg-body);
            overflow: hidden;
        }

        .chat-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-header h1 {
            margin: 0;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .model-selector {
            padding: 0.5rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 85%;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.2rem;
        }

        .message.user .message-avatar {
            background: var(--primary-gradient);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }

        .message-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            line-height: 1.5;
            word-wrap: break-word;
            max-width: 800px;
            overflow-x: auto;
        }

        .message-content * {
            line-height: 1.5;
        }

        .message-content p {
            margin: 0.25rem 0;
        }

        .message-content br {
            line-height: 1.5;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.25rem 0;
            font-size: 0.95em;
        }

        .message-content table th,
        .message-content table td {
            border: 1px solid var(--border-color);
            padding: 0.25rem 0.4rem;
            text-align: left;
            line-height: 1.5;
        }

        .message-content table th {
            background: rgba(99, 102, 241, 0.1);
            font-weight: 500;
        }

        .message-content table tr {
            line-height: 1.5;
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .message.user .message-content img {
            max-width: 400px !important;
            width: 100%;
            height: auto;
            border-radius: var(--radius-md);
            margin: 0.5rem 0;
            display: block;
        }

        .message-content pre {
            background: var(--bg-input);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message-content code {
            background: var(--bg-input);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .message-content img {
            max-width: 600px !important;
            width: 100%;
            height: auto;
            border-radius: var(--radius-md);
            margin: 0.5rem 0;
            display: block;
        }

        .thinking-section {
            margin: 0 0 0.75rem 0;
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--primary-color);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1;
        }

        .thinking-section summary {
            cursor: pointer;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 0;
            line-height: 1;
        }

        .chat-input-container {
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            flex-shrink: 0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            max-width: 1200px;
            margin: 0 auto;
        }

        .file-upload-btn {
            padding: 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            width: 48px;
            height: 48px;
        }

        .file-upload-btn:hover {
            background: var(--bg-card);
            border-color: var(--primary-color);
        }

        .file-upload-btn svg {
            width: 20px;
            height: 20px;
        }

        .file-input {
            display: none;
        }

        .file-preview {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-input);
            border-radius: var(--radius-md);
        }

        .file-preview-item {
            position: relative;
            display: inline-block;
        }

        .file-preview-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .file-preview-item .file-icon {
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
            padding: 0.25rem;
            word-break: break-all;
            overflow: hidden;
        }

        .file-preview-item .file-icon svg {
            width: 24px;
            height: 24px;
            margin-bottom: 0.25rem;
        }

        .file-preview-item .remove-file {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--danger-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
            padding: 0;
        }

        .file-preview-item .remove-file:hover {
            background: #dc2626;
        }

        .chat-input {
            flex: 1;
            min-height: 60px;
            max-height: 200px;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            overflow-y: auto;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .send-button {
            padding: 0.75rem 2rem;
            background: var(--primary-gradient);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pause-button {
            padding: 0.75rem 1rem;
            background: var(--warning-color, #f59e0b);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
            line-height: 1;
        }

        .pause-button:hover:not(:disabled) {
            background: var(--warning-hover, #d97706);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .pause-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--text-secondary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* æ­£åœ¨æ€è€ƒåŠ¨ç”» - æ—‹è½¬åœ†åœˆ */
        .thinking-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem 0;
        }

        .thinking-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: thinking-spin 0.8s linear infinite;
        }

        @keyframes thinking-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 3rem;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* æ•°å­¦å…¬å¼æ ·å¼ */
        .math-block {
            margin: 0.25rem 0;
            padding: 0.25rem 0;
            text-align: center;
            overflow-x: auto;
            max-width: 100%;
        }

        .math-inline {
            display: inline-block;
            margin: 0 0.15em;
            vertical-align: baseline;
        }

        /* KaTeX æ ·å¼è¦†ç›– */
        .katex {
            font-size: 1.05em;
        }

        .katex-display {
            margin: 0.25rem 0 !important;
        }

        .message-content .katex-display {
            margin: 0.25rem 0 !important;
            max-width: 100%;
            overflow-x: auto;
        }

        .message-content .katex {
            max-width: 100%;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <header class="chat-header">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                åœ¨çº¿å¯¹è¯
            </h1>
            <div class="chat-header-actions">
                <select id="modelSelect" class="model-selector">
                    <option value="gemini-auto">gemini-auto (è‡ªåŠ¨)</option>
                    <option value="gemini-2.5-flash">gemini-2.5-flash (å¿«é€Ÿ)</option>
                    <option value="gemini-2.5-pro">gemini-2.5-pro (å¹³è¡¡)</option>
                    <option value="gemini-3-pro-preview" selected>gemini-3-pro-preview (æ——èˆ°)</option>
                </select>
                <a href="/static/dashboard.html" class="btn-secondary">è¿”å›ç®¡ç†</a>
                <button id="clearChatBtn" class="btn-secondary">æ¸…ç©ºå¯¹è¯</button>
            </div>
        </header>

        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <p>å¼€å§‹å¯¹è¯å§ï¼è¾“å…¥æ¶ˆæ¯åæŒ‰ Enter æˆ–ç‚¹å‡»å‘é€æŒ‰é’®ã€‚</p>
            </div>
        </div>

        <div class="chat-input-container">
            <div id="filePreview" class="file-preview" style="display: none;"></div>
            <div class="chat-input-wrapper">
                <label for="fileInput" class="file-upload-btn" title="ä¸Šä¼ æ–‡ä»¶">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </label>
                <input type="file" id="fileInput" class="file-input" multiple>
                <textarea id="chatInput" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enter æ¢è¡Œï¼ŒEnter å‘é€)" rows="1"></textarea>
                <button id="pauseButton" class="pause-button" disabled title="æš‚åœ">â¸</button>
                <button id="sendButton" class="send-button">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/static/index.html';
        }

        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const pauseButton = document.getElementById('pauseButton');
        const modelSelect = document.getElementById('modelSelect');
        const clearChatBtn = document.getElementById('clearChatBtn');
        
        let abortController = null; // ç”¨äºæ§åˆ¶è¯·æ±‚ä¸­æ–­

        let messages = [];
        let currentStreamingMessage = null;
        let uploadedFiles = []; // å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶ {file: File, base64: string, mime: string, name: string}

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                try {
                    const base64 = await fileToBase64(file);
                    uploadedFiles.push({
                        file: file,
                        base64: base64,
                        mime: file.type || 'application/octet-stream',
                        name: file.name,
                        size: file.size
                    });
                    updateFilePreview();
                } catch (error) {
                    console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                    alert(`æ–‡ä»¶ ${file.name} è¯»å–å¤±è´¥`);
                }
            }
            // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            fileInput.value = '';
        });

        // æ–‡ä»¶è½¬ base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) {
                return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>';
            } else if (mimeType.includes('pdf')) {
                return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>';
            } else if (mimeType.includes('text') || mimeType.includes('json') || mimeType.includes('xml')) {
                return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>';
            } else {
                return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>';
            }
        }

        // æ›´æ–°æ–‡ä»¶é¢„è§ˆ
        function updateFilePreview() {
            if (uploadedFiles.length === 0) {
                filePreview.style.display = 'none';
                return;
            }

            filePreview.style.display = 'flex';
            filePreview.innerHTML = uploadedFiles.map((item, index) => {
                const isImage = item.mime.startsWith('image/');
                if (isImage) {
                    return `
                        <div class="file-preview-item">
                            <img src="data:${item.mime};base64,${item.base64}" alt="${item.name}">
                            <button class="remove-file" onclick="removeFile(${index})" title="ç§»é™¤">Ã—</button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="file-preview-item">
                            <div class="file-icon">
                                ${getFileIcon(item.mime)}
                                <span style="font-size: 0.6rem; max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</span>
                            </div>
                            <button class="remove-file" onclick="removeFile(${index})" title="ç§»é™¤">Ã—</button>
                        </div>
                    `;
                }
            }).join('');
        }

        // ç§»é™¤æ–‡ä»¶ï¼ˆå…¨å±€å‡½æ•°ï¼Œä¾› onclick è°ƒç”¨ï¼‰
        window.removeFile = function(index) {
            uploadedFiles.splice(index, 1);
            updateFilePreview();
        };

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const content = chatInput.value.trim();
            const hasFiles = uploadedFiles.length > 0;
            
            if (!content && !hasFiles) return;
            if (sendButton.disabled) return;

            // æ„å»ºæ¶ˆæ¯å†…å®¹
            let messageContent = content;
            let messageImages = [];
            let fileInfoText = '';

            // å¦‚æœæœ‰ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæ„å»ºåŒ…å«æ–‡ä»¶çš„æ¶ˆæ¯æ ¼å¼
            if (hasFiles) {
                const imageFiles = [];
                const otherFiles = [];

                // åˆ†ç¦»å›¾ç‰‡æ–‡ä»¶å’Œå…¶ä»–æ–‡ä»¶
                uploadedFiles.forEach(item => {
                    if (item.mime.startsWith('image/')) {
                        imageFiles.push(item);
                    } else {
                        otherFiles.push(item);
                    }
                });

                // å¤„ç†å›¾ç‰‡æ–‡ä»¶ï¼ˆä½¿ç”¨ image_url æ ¼å¼ï¼‰
                if (imageFiles.length > 0) {
                    messageImages = imageFiles.map(item => ({
                        type: "image_url",
                        image_url: {
                            url: `data:${item.mime};base64,${item.base64}`
                        }
                    }));
                }

                // å¤„ç†éå›¾ç‰‡æ–‡ä»¶ï¼ˆä»¥æ–‡æœ¬å½¢å¼å‘é€æ–‡ä»¶ä¿¡æ¯ï¼‰
                if (otherFiles.length > 0) {
                    const fileInfoList = otherFiles.map(item => {
                        const size = formatFileSize(item.size || 0);
                        return `ğŸ“ ${item.name} (${size}, ${item.mime})`;
                    });
                    fileInfoText = '\n\n' + fileInfoList.join('\n');
                }

                // ç»„åˆæ¶ˆæ¯å†…å®¹
                if (messageImages.length > 0) {
                    // æœ‰å›¾ç‰‡ï¼Œä½¿ç”¨æ•°ç»„æ ¼å¼
                    const textParts = [];
                    if (content || fileInfoText) {
                        textParts.push({ 
                            type: "text", 
                            text: (content || '') + fileInfoText 
                        });
                    }
                    messageContent = [...textParts, ...messageImages];
                    if (messageContent.length === 0) {
                        messageContent = messageImages;
                    }
                } else if (fileInfoText) {
                    // åªæœ‰éå›¾ç‰‡æ–‡ä»¶ï¼Œæ·»åŠ åˆ°æ–‡æœ¬å†…å®¹
                    messageContent = (content || '') + fileInfoText;
                }
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºæ–‡æœ¬ã€å›¾ç‰‡é¢„è§ˆå’Œæ–‡ä»¶ä¿¡æ¯ï¼‰
            let displayContent = content;
            if (hasFiles) {
                const imagePreviews = uploadedFiles
                    .filter(item => item.mime.startsWith('image/'))
                    .map(item => `![${item.name}](data:${item.mime};base64,${item.base64})`)
                    .join('\n');
                
                const fileInfo = uploadedFiles
                    .filter(item => !item.mime.startsWith('image/'))
                    .map(item => {
                        const size = formatFileSize(item.size || 0);
                        return `ğŸ“ ${item.name} (${size})`;
                    })
                    .join('\n');

                const parts = [];
                if (content) parts.push(content);
                if (imagePreviews) parts.push(imagePreviews);
                if (fileInfo) parts.push(fileInfo);
                displayContent = parts.join('\n\n');
            }
            addMessage('user', displayContent);
            
            chatInput.value = '';
            chatInput.style.height = 'auto';
            uploadedFiles = [];
            updateFilePreview();

            // ä¿å­˜åˆ°æ¶ˆæ¯å†å²
            messages.push({ role: 'user', content: messageContent });

            // ç¦ç”¨è¾“å…¥
            sendButton.disabled = true;
            chatInput.disabled = true;
            sendButton.innerHTML = '<span class="loading-indicator"></span>';
            pauseButton.disabled = false; // å¯ç”¨æš‚åœæŒ‰é’®

            // åˆ›å»º AbortController ç”¨äºä¸­æ–­è¯·æ±‚
            abortController = new AbortController();

            try {
                const model = modelSelect.value;
                const response = await fetch('/admin/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        stream: true,
                        temperature: 0.7
                    }),
                    signal: abortController.signal
                });

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/static/index.html';
                    return;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'è¯·æ±‚å¤±è´¥');
                }

                // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨ï¼Œæ˜¾ç¤º"æ­£åœ¨æ€è€ƒ"æ—‹è½¬åœ†åœˆåŠ¨ç”»
                const assistantMessageId = addMessage('assistant', '<div class="thinking-indicator"><div class="thinking-spinner"></div></div>');
                currentStreamingMessage = assistantMessageId;
                let fullContent = '';
                let thinkingContent = '';
                let buffer = ''; // ç”¨äºå¤„ç†å¯èƒ½è¢«åˆ†å‰²çš„ JSON
                let hasReceivedContent = false; // æ ‡è®°æ˜¯å¦å·²æ”¶åˆ°å†…å®¹

                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
                    if (abortController && abortController.signal.aborted) {
                        try {
                            reader.cancel();
                        } catch (e) {
                            // å¿½ç•¥å–æ¶ˆé”™è¯¯
                        }
                        break;
                    }
                    
                    const { done, value } = await reader.read();
                    if (done) {
                        // å¤„ç†å‰©ä½™çš„ buffer
                        if (buffer.trim()) {
                            const lines = buffer.split('\n');
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6);
                                    if (data === '[DONE]') continue;
                                    try {
                                        const json = JSON.parse(data);
                                        const delta = json.choices[0]?.delta;
                                        if (delta?.content) {
                                            fullContent += delta.content;
                                        }
                                        if (delta?.thinking) {
                                            thinkingContent = delta.thinking;
                                        }
                                    } catch (e) {
                                        // å¿½ç•¥è§£æé”™è¯¯
                                    }
                                }
                            }
                        }
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const json = JSON.parse(data);
                                const delta = json.choices[0]?.delta;

                                // å¤„ç†æ€è€ƒè¿‡ç¨‹ï¼ˆä¼˜å…ˆä½¿ç”¨ thinking å­—æ®µï¼‰
                                if (delta?.thinking) {
                                    thinkingContent = delta.thinking;
                                    // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼Œä½†ä¸åŒ…å« content
                                    updateMessage(assistantMessageId, fullContent, thinkingContent);
                                }
                                
                                // å¤„ç†å†…å®¹
                                if (delta?.content) {
                                    // æ ‡è®°å·²æ”¶åˆ°å†…å®¹ï¼Œç§»é™¤"æ­£åœ¨æ€è€ƒ"åŠ¨ç”»
                                    if (!hasReceivedContent) {
                                        hasReceivedContent = true;
                                        fullContent = ''; // é‡ç½®å†…å®¹ï¼Œç§»é™¤"æ­£åœ¨æ€è€ƒ"æç¤º
                                    }
                                    
                                    let content = delta.content;
                                    
                                    // å¦‚æœå·²ç»æ”¶åˆ° thinking å­—æ®µï¼Œå®Œå…¨ç§»é™¤ content ä¸­çš„æ€è€ƒè¿‡ç¨‹ HTML
                                    if (thinkingContent) {
                                        // æ›´å½»åº•çš„æ­£åˆ™åŒ¹é…ï¼ŒåŒ…æ‹¬å„ç§å¯èƒ½çš„æ ¼å¼
                                        content = content
                                            .replace(/<details><summary>æ˜¾ç¤ºæ€è·¯<\/summary>[\s\S]*?<\/details>/gi, '')
                                            .replace(/<details><summary>æ˜¾ç¤ºæ€è·¯<\/summary>[\s\S]*?<\/details>/g, '')
                                            .replace(/æ˜¾ç¤ºæ€è·¯[\s\S]*?<\/details>/g, '')
                                            .trim();
                                    } else {
                                        // å¦‚æœè¿˜æ²¡æœ‰æ”¶åˆ° thinking å­—æ®µï¼Œå°è¯•ä» content ä¸­æå–
                                        const thinkingMatch = content.match(/<details><summary>æ˜¾ç¤ºæ€è·¯<\/summary>\s*\n*\n*([\s\S]*?)\n*\n*<\/details>/i);
                                        if (thinkingMatch) {
                                            thinkingContent = thinkingMatch[1].trim();
                                            // ç§»é™¤æ€è€ƒè¿‡ç¨‹ HTML
                                            content = content.replace(/<details><summary>æ˜¾ç¤ºæ€è·¯<\/summary>[\s\S]*?<\/details>/gi, '').trim();
                                        }
                                    }
                                    
                                    // åªæ·»åŠ éç©ºçš„ content
                                    if (content) {
                                        fullContent += content;
                                    }
                                    // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼Œå®ç°æµå¼è¾“å‡º
                                    updateMessage(assistantMessageId, fullContent, thinkingContent);
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯ï¼Œå¯èƒ½æ˜¯ JSON ä¸å®Œæ•´
                            }
                        }
                    }
                }
                
                // æµå¼è¾“å‡ºå®Œæˆåï¼Œæœ€ç»ˆæ›´æ–°ä¸€æ¬¡ä»¥ç¡®ä¿å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º
                // å¦‚æœè¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•å†…å®¹ï¼Œç§»é™¤"æ­£åœ¨æ€è€ƒ"æç¤º
                if (!hasReceivedContent && fullContent === '') {
                    updateMessage(assistantMessageId, 'æš‚æ— å›å¤', thinkingContent);
                } else {
                    updateMessage(assistantMessageId, fullContent, thinkingContent);
                }

                // ä¿å­˜åŠ©æ‰‹å›å¤
                messages.push({ role: 'assistant', content: fullContent });
                currentStreamingMessage = null;

            } catch (error) {
                // å¦‚æœæ˜¯ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                if (error.name === 'AbortError') {
                    // ç”¨æˆ·ä¸»åŠ¨æš‚åœï¼Œç§»é™¤è½¬åœˆåŠ¨ç”»å¹¶æ›´æ–°æ¶ˆæ¯
                    if (currentStreamingMessage) {
                        const messageEl = document.getElementById(currentStreamingMessage);
                        if (messageEl) {
                            const contentEl = messageEl.querySelector('.message-content');
                            if (contentEl) {
                                // ç§»é™¤è½¬åœˆåŠ¨ç”»
                                const thinkingIndicator = contentEl.querySelector('.thinking-indicator');
                                if (thinkingIndicator) {
                                    thinkingIndicator.remove();
                                }
                                // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œæ˜¾ç¤º"å·²æš‚åœ"
                                if (contentEl.textContent.trim() === '' || contentEl.innerHTML.includes('thinking-spinner')) {
                                    updateMessage(currentStreamingMessage, fullContent || 'å·²æš‚åœ', thinkingContent);
                                } else {
                                    // å¦‚æœæœ‰å†…å®¹ï¼Œåªç§»é™¤åŠ¨ç”»ï¼Œä¿ç•™å†…å®¹
                                    updateMessage(currentStreamingMessage, fullContent, thinkingContent);
                                }
                            }
                        }
                    }
                } else {
                    addMessage('assistant', `âŒ é”™è¯¯: ${error.message}`, true);
                }
            } finally {
                sendButton.disabled = false;
                chatInput.disabled = false;
                sendButton.textContent = 'å‘é€';
                pauseButton.disabled = true; // ç¦ç”¨æš‚åœæŒ‰é’®ï¼ˆå› ä¸ºæ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼‰
                abortController = null;
                chatInput.focus();
            }
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(role, content, isError = false) {
            const emptyState = chatMessages.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageId = 'msg-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.id = messageId;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            if (isError) {
                contentDiv.style.color = 'var(--danger-color)';
            }
            // å¦‚æœæ˜¯æ€è€ƒæŒ‡ç¤ºå™¨ï¼Œç›´æ¥è®¾ç½® HTMLï¼Œä¸ç»è¿‡ formatMessage
            if (content.includes('thinking-indicator')) {
                contentDiv.innerHTML = content;
            } else {
                contentDiv.innerHTML = formatMessage(content, role === 'user');
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

            // æ¸²æŸ“æ•°å­¦å…¬å¼
            setTimeout(() => {
                renderMath(contentDiv);
            }, 50);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return messageId;
        }

        // æ›´æ–°æ¶ˆæ¯å†…å®¹ï¼ˆæµå¼ï¼‰
        function updateMessage(messageId, content, thinking = '') {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;

            const contentDiv = messageDiv.querySelector('.message-content');
            
            // åœ¨æ ¼å¼åŒ–å‰ç§»é™¤æ€è€ƒè¿‡ç¨‹ HTMLï¼ˆé¿å…é‡å¤æ˜¾ç¤ºï¼‰
            let cleanContent = content;
            if (thinking && thinking.trim()) {
                // å¦‚æœå·²ç»æœ‰ thinking å­—æ®µï¼Œå½»åº•ç§»é™¤ content ä¸­çš„æ€è€ƒè¿‡ç¨‹ç›¸å…³ HTML
                cleanContent = cleanContent
                    .replace(/<details><summary>æ˜¾ç¤ºæ€è·¯<\/summary>[\s\S]*?<\/details>/gi, '')
                    .replace(/<details>[\s\S]*?æ˜¾ç¤ºæ€è·¯[\s\S]*?<\/details>/gi, '')
                    .replace(/æ˜¾ç¤ºæ€è·¯[\s\S]*?<\/details>/gi, '')
                    .replace(/æ€è€ƒè¿‡ç¨‹[\s\S]*?<\/details>/gi, '')
                    .trim();
            }
            
            // åˆ¤æ–­æ˜¯å¦æ˜¯ç”¨æˆ·æ¶ˆæ¯
            const isUserMessage = messageDiv.classList.contains('user');
            let html = formatMessage(cleanContent, isUserMessage);

            // åªåœ¨æœ‰æ€è€ƒå†…å®¹ä¸”å†…å®¹ä¸ä¸ºç©ºæ—¶æ˜¾ç¤º
            if (thinking && thinking.trim()) {
                // æ ¼å¼åŒ–æ€è€ƒå†…å®¹ï¼ˆæ¢è¡Œå¤„ç†ï¼‰
                const formattedThinking = thinking.split('\n').map(line => escapeHtml(line.trim())).filter(line => line).join('\n');
                html = `<div class="thinking-section"><details><summary>ğŸ’­ æ€è€ƒè¿‡ç¨‹</summary><pre style="white-space: pre-wrap; word-wrap: break-word;">${formattedThinking}</pre></details></div>` + html;
            }

            contentDiv.innerHTML = html;

            // æ¸²æŸ“æ•°å­¦å…¬å¼
            setTimeout(() => {
                renderMath(contentDiv);
            }, 50);
            
            // ç¡®ä¿å›¾ç‰‡æ­£ç¡®åŠ è½½ï¼ˆå¤„ç†å¯èƒ½çš„å»¶è¿Ÿæˆ–åˆ†å‰²çš„ base64 æ•°æ®ï¼‰
            setTimeout(() => {
                const images = contentDiv.querySelectorAll('img[src^="data:"]');
                images.forEach(img => {
                    if (!img.complete || img.naturalHeight === 0) {
                        // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°è¯•é‡æ–°è®¾ç½® src
                        const src = img.getAttribute('src');
                        if (src) {
                            img.src = '';
                            img.src = src;
                        }
                    }
                });
            }, 100);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆMarkdown å®Œæ•´æ”¯æŒï¼‰
        function formatMessage(content, isUserMessage = false) {
            if (!content) return '';

            // å…ˆå½»åº•ç§»é™¤å¯èƒ½æ®‹ç•™çš„æ€è€ƒè¿‡ç¨‹ HTML å’Œè½¬åœˆåŠ¨ç”»
            content = content
                .replace(/<details><summary>æ˜¾ç¤ºæ€è·¯<\/summary>[\s\S]*?<\/details>/gi, '')
                .replace(/<details>[\s\S]*?æ˜¾ç¤ºæ€è·¯[\s\S]*?<\/details>/gi, '')
                .replace(/æ˜¾ç¤ºæ€è·¯[\s\S]*?<\/details>/gi, '')
                .replace(/<div[^>]*class="thinking-indicator"[^>]*>[\s\S]*?<\/div>/gi, '')
                .replace(/<div[^>]*thinking-indicator[^>]*>[\s\S]*?<\/div>/gi, '')
                .trim();

            // ä¿å­˜å·²å­˜åœ¨çš„ HTML æ ‡ç­¾ï¼ˆå›¾ç‰‡ã€é“¾æ¥ã€ä»£ç å—ç­‰ï¼‰
            const htmlPlaceholders = {};
            let placeholderIndex = 0;
            // ä¿å­˜å…¶ä»– HTML æ ‡ç­¾
            content = content.replace(/<(img|a|pre|code|strong|em|details|summary|div)[^>]*>[\s\S]*?<\/\1>/gi, (match) => {
                const placeholder = `__HTML_PLACEHOLDER_${placeholderIndex}__`;
                htmlPlaceholders[placeholder] = match;
                placeholderIndex++;
                return placeholder;
            });

            // è½¬ä¹‰ HTML
            let html = escapeHtml(content);

            // æ¢å¤å·²å­˜åœ¨çš„ HTML æ ‡ç­¾
            for (const [placeholder, tag] of Object.entries(htmlPlaceholders)) {
                html = html.replace(placeholder, tag);
            }

            // Markdown è¡¨æ ¼å¤„ç†ï¼ˆå¿…é¡»åœ¨å…¶ä»–å¤„ç†ä¹‹å‰ï¼‰
            html = html.replace(/\|(.+)\|/g, (match, row) => {
                const cells = row.split('|').map(cell => cell.trim());
                return '|' + cells.join('|') + '|';
            });
            
            // æ£€æµ‹è¡¨æ ¼
            const tableRegex = /(\|.+\|\n\|[:\-| ]+\|\n)(\|.+\|\n?)+/g;
            html = html.replace(tableRegex, (match) => {
                const lines = match.trim().split('\n');
                if (lines.length < 2) return match;
                
                const headerRow = lines[0];
                const separatorRow = lines[1];
                const dataRows = lines.slice(2);
                
                const headerCells = headerRow.split('|').filter(c => c.trim()).map(c => c.trim());
                let tableHtml = '<table><thead><tr>';
                headerCells.forEach(cell => {
                    tableHtml += `<th>${cell}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';
                
                dataRows.forEach(row => {
                    const cells = row.split('|').filter(c => c.trim()).map(c => c.trim());
                    if (cells.length > 0) {
                        tableHtml += '<tr>';
                        cells.forEach(cell => {
                            tableHtml += `<td>${cell}</td>`;
                        });
                        tableHtml += '</tr>';
                    }
                });
                
                tableHtml += '</tbody></table>';
                return tableHtml;
            });

            // æ ‡é¢˜ï¼ˆ### æ ‡é¢˜ï¼‰
            html = html.replace(/^### (.+)$/gm, '<h3 style="margin: 0.5rem 0; line-height: 1.5; font-size: 1.2rem; font-weight: 600;">$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2 style="margin: 0.5rem 0; line-height: 1.5; font-size: 1.4rem; font-weight: 600;">$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1 style="margin: 0.5rem 0; line-height: 1.5; font-size: 1.6rem; font-weight: 600;">$1</h1>');

            // æ°´å¹³çº¿
            html = html.replace(/^---$/gm, '<hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0; line-height: 1.5;">');
            html = html.replace(/^___$/gm, '<hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0; line-height: 1.5;">');
            html = html.replace(/^\*\*\*$/gm, '<hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0; line-height: 1.5;">');

            // æ— åºåˆ—è¡¨
            html = html.replace(/^[\*\-\+] (.+)$/gm, '<li style="line-height: 1.5; margin: 0.25rem 0;">$1</li>');
            html = html.replace(/(<li[^>]*>.*<\/li>\n?)+/g, (match) => {
                return '<ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.5;">' + match + '</ul>';
            });

            // æœ‰åºåˆ—è¡¨
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            // æ³¨æ„ï¼šæœ‰åºåˆ—è¡¨éœ€è¦æ›´å¤æ‚çš„å¤„ç†ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†

            // ä»£ç å—ï¼ˆå¿…é¡»åœ¨è¡Œå†…ä»£ç ä¹‹å‰ï¼‰
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre style="background: var(--bg-input); padding: 0.75rem; border-radius: var(--radius-md); overflow-x: auto; margin: 0.5rem 0; line-height: 1.5;"><code style="line-height: 1.5;">${escapeHtml(code.trim())}</code></pre>`;
            });

            // è¡Œå†…ä»£ç 
            html = html.replace(/`([^`\n]+)`/g, '<code style="background: var(--bg-input); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.9em;">$1</code>');

            // ç²—ä½“
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // æ–œä½“
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // åˆ é™¤çº¿
            html = html.replace(/~~(.+?)~~/g, '<del>$1</del>');

            // å›¾ç‰‡ï¼ˆbase64ï¼‰- å¿…é¡»åœ¨é“¾æ¥ä¹‹å‰å¤„ç†ï¼Œé¿å…è¢«é“¾æ¥æ­£åˆ™åŒ¹é…
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒçš„æœ€å¤§å®½åº¦
            const maxImageWidth = isUserMessage ? '400px' : '600px';
            
            // å…ˆå¤„ç†å®Œæ•´çš„å›¾ç‰‡é“¾æ¥ï¼ˆæ ‡å‡†æ ¼å¼ï¼Œbase64 æ•°æ®å¯èƒ½å¾ˆé•¿ï¼Œä½¿ç”¨éè´ªå©ªåŒ¹é…åˆ°å³æ‹¬å·ï¼‰
            html = html.replace(/!\[([^\]]*)\]\(data:([^;]+);base64,([A-Za-z0-9+\/=]+)\)/g, (match, alt, mime, base64) => {
                // base64 æ•°æ®å¿…é¡»è¶³å¤Ÿé•¿ï¼ˆå›¾ç‰‡è‡³å°‘å‡ ç™¾å­—ç¬¦ï¼‰
                if (base64.length > 100 && /^[A-Za-z0-9+\/=]+$/.test(base64)) {
                    return `<img src="data:${mime};base64,${base64}" alt="${alt || 'ç”Ÿæˆçš„å›¾ç‰‡'}" style="max-width: ${maxImageWidth} !important; width: 100%; height: auto; border-radius: var(--radius-md); margin: 0.5rem 0; display: block;" />`;
                }
                return match;
            });
            
            // å†å¤„ç†å¯èƒ½åŒ…å«ç©ºç™½å­—ç¬¦æˆ–æ¢è¡Œçš„ base64 æ•°æ®ï¼ˆæµå¼è¾“å‡ºæ—¶å¯èƒ½è¢«åˆ†å‰²ï¼‰
            // åŒ¹é…åˆ°æ¢è¡Œã€ç»“æŸæ ‡ç­¾æˆ–å­—ç¬¦ä¸²ç»“å°¾ï¼Œä½¿ç”¨éè´ªå©ªåŒ¹é…
            html = html.replace(/!\[([^\]]*)\]\(data:([^;]+);base64,([A-Za-z0-9+\/=\s\n\r]+?)(?:\n\n|<\/|\)|$)/g, (match, alt, mime, base64) => {
                // æ¸…ç† base64 æ•°æ®ä¸­çš„ç©ºç™½å­—ç¬¦
                const cleanBase64 = base64.replace(/[\s\n\r]+/g, '');
                // åªå¤„ç†è¶³å¤Ÿé•¿çš„ base64 æ•°æ®ï¼ˆé¿å…è¯¯åŒ¹é…ï¼Œbase64 å›¾ç‰‡é€šå¸¸è‡³å°‘å‡ ç™¾å­—ç¬¦ï¼‰
                if (cleanBase64.length > 100 && /^[A-Za-z0-9+\/=]+$/.test(cleanBase64)) {
                    return `<img src="data:${mime};base64,${cleanBase64}" alt="${alt || 'ç”Ÿæˆçš„å›¾ç‰‡'}" style="max-width: ${maxImageWidth} !important; width: 100%; height: auto; border-radius: var(--radius-md); margin: 0.5rem 0; display: block;" />`;
                }
                return match;
            });

            // é“¾æ¥ï¼ˆå¿…é¡»åœ¨å›¾ç‰‡ä¹‹åï¼Œé¿å…åŒ¹é…å›¾ç‰‡æ ¼å¼ï¼‰
            // æ’é™¤ä»¥ data: å¼€å¤´çš„é“¾æ¥ï¼ˆè¿™äº›æ˜¯å›¾ç‰‡ï¼‰
            html = html.replace(/\[([^\]]+)\]\((?!data:)([^\)]+)\)/g, '<a href="$2" target="_blank" style="color: var(--primary-color); text-decoration: underline;">$1</a>');

            // å¼•ç”¨å—
            html = html.replace(/^> (.+)$/gm, '<blockquote style="border-left: 3px solid var(--primary-color); padding-left: 1rem; margin: 0.5rem 0; line-height: 1.5; color: var(--text-secondary);">$1</blockquote>');

            // æ•°å­¦å…¬å¼å¤„ç†ï¼ˆå¿…é¡»åœ¨æ¢è¡Œä¹‹å‰ï¼‰
            // å…ˆä¿å­˜å·²å­˜åœ¨çš„å…¬å¼å…ƒç´ ï¼Œé¿å…é‡å¤å¤„ç†
            const existingMath = {};
            html = html.replace(/<(div|span)[^>]*class="(math-block|math-inline)"[^>]*>[\s\S]*?<\/\1>/gi, (match) => {
                const placeholder = `__MATH_PLACEHOLDER_${Object.keys(existingMath).length}__`;
                existingMath[placeholder] = match;
                return placeholder;
            });
            
            // å—çº§å…¬å¼ $$...$$ï¼ˆåªåŒ¹é…æœªå¤„ç†çš„ï¼‰
            html = html.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
                // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å¤„ç†è¿‡
                if (match.includes('math-block') || match.includes('katex')) {
                    return match;
                }
                const id = 'math-block-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                return `<div class="math-block" id="${id}">${escapeHtml(formula.trim())}</div>`;
            });
            
            // è¡Œå†…å…¬å¼ $...$ï¼ˆåªåŒ¹é…æœªå¤„ç†çš„ï¼Œæ’é™¤å—çº§å…¬å¼ï¼‰
            html = html.replace(/\$([^\$\n]+?)\$/g, (match, formula) => {
                // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å¤„ç†è¿‡æˆ–è€…æ˜¯å—çº§å…¬å¼çš„ä¸€éƒ¨åˆ†
                if (match.includes('math-inline') || match.includes('math-block') || match.includes('katex')) {
                    return match;
                }
                // æ’é™¤å—çº§å…¬å¼çš„è¾¹ç•Œ
                if (match.startsWith('$$') || match.endsWith('$$')) {
                    return match;
                }
                const id = 'math-inline-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                return `<span class="math-inline" id="${id}">${escapeHtml(formula.trim())}</span>`;
            });
            
            // æ¢å¤å·²å­˜åœ¨çš„å…¬å¼å…ƒç´ 
            for (const [placeholder, mathHtml] of Object.entries(existingMath)) {
                html = html.replace(placeholder, mathHtml);
            }

            // æ¢è¡Œå¤„ç†ï¼ˆæœ€åå¤„ç†ï¼‰
            // å…ˆå¤„ç†è¿ç»­çš„ç©ºè¡Œï¼Œåˆå¹¶ä¸ºå•ä¸ªæ¢è¡Œ
            html = html.replace(/\n{3,}/g, '\n\n');
            // å°†å•ä¸ªæ¢è¡Œè½¬æ¢ä¸º <br>ï¼Œä½†ä¿ç•™æ®µè½ç»“æ„
            html = html.replace(/\n/g, '<br>');
            // åˆå¹¶è¿ç»­çš„ <br>ï¼Œæœ€å¤šä¿ç•™ä¸¤ä¸ªï¼ˆæ®µè½é—´è·ï¼‰
            html = html.replace(/(<br>\s*){3,}/gi, '<br><br>');

            return html;
        }

        // æ¸²æŸ“æ•°å­¦å…¬å¼
        function renderMath(element) {
            if (typeof katex === 'undefined') {
                // KaTeX æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½
                setTimeout(() => renderMath(element), 100);
                return;
            }

            try {
                // æ¸²æŸ“å—çº§å…¬å¼ï¼ˆåªæ¸²æŸ“æœªæ¸²æŸ“è¿‡çš„ï¼‰
                const blockElements = element.querySelectorAll('.math-block:not(.katex-display):not([data-rendered])');
                blockElements.forEach(el => {
                    try {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æ¸²æŸ“è¿‡
                        if (el.classList.contains('katex-display') || el.querySelector('.katex')) {
                            return;
                        }
                        const formula = el.textContent.trim();
                        if (formula && !el.hasAttribute('data-rendered')) {
                            katex.render(formula, el, {
                                displayMode: true,
                                throwOnError: false,
                                errorColor: '#cc0000'
                            });
                            el.setAttribute('data-rendered', 'true');
                        }
                    } catch (e) {
                        console.error('Math block render error:', e);
                    }
                });

                // æ¸²æŸ“è¡Œå†…å…¬å¼ï¼ˆåªæ¸²æŸ“æœªæ¸²æŸ“è¿‡çš„ï¼‰
                const inlineElements = element.querySelectorAll('.math-inline:not(.katex):not([data-rendered])');
                inlineElements.forEach(el => {
                    try {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æ¸²æŸ“è¿‡
                        if (el.classList.contains('katex') || el.querySelector('.katex')) {
                            return;
                        }
                        const formula = el.textContent.trim();
                        if (formula && !el.hasAttribute('data-rendered')) {
                            katex.render(formula, el, {
                                displayMode: false,
                                throwOnError: false,
                                errorColor: '#cc0000'
                            });
                            el.setAttribute('data-rendered', 'true');
                        }
                    } catch (e) {
                        console.error('Math inline render error:', e);
                    }
                });
            } catch (e) {
                console.error('Math rendering error:', e);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ¸…ç©ºå¯¹è¯
        clearChatBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯å—ï¼Ÿ')) {
                messages = [];
                chatMessages.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>å¼€å§‹å¯¹è¯å§ï¼è¾“å…¥æ¶ˆæ¯åæŒ‰ Enter æˆ–ç‚¹å‡»å‘é€æŒ‰é’®ã€‚</p>
                    </div>
                `;
            }
        });

        // å‘é€æŒ‰é’®ç‚¹å‡»
        sendButton.addEventListener('click', sendMessage);
        
        // æš‚åœæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        pauseButton.addEventListener('click', () => {
            if (abortController && !pauseButton.disabled) {
                abortController.abort();
                pauseButton.disabled = true; // ç¦ç”¨æš‚åœæŒ‰é’®
                sendButton.disabled = false;
                chatInput.disabled = false;
                sendButton.textContent = 'å‘é€';
            }
        });

        // èšç„¦è¾“å…¥æ¡†
        chatInput.focus();
    </script>
</body>

</html>

